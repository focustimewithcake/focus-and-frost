
    // Hàm lưu lịch sử phiên tập trung vào localStorage
    function saveSessionHistory(elapsedSeconds) {
      let history = JSON.parse(localStorage.getItem('sessionHistory')) || [];
      const now = new Date();
      const durationMinutes = Math.floor(elapsedSeconds / 60);
      history.push({
        date: now.toISOString(),
        durationMinutes: durationMinutes,
        cake: selectedCake || null,
        timeSeconds: elapsedSeconds || 0,
        rewards: [], // can be extended to store actual rewards
        userId: user ? user.id : null
      });
      localStorage.setItem('sessionHistory', JSON.stringify(history));
      sessionHistory = history; // update in-memory copy
      console.log("Đã lưu sessionHistory:", history);
    }

    // Nút chuyển trang
    document.getElementById('btn-decoration').addEventListener('click', function() {
      window.location.href = 'decorate.html';
    });

    btnStatistics.addEventListener('click', () => {
      if (isRunning) return; // disable while running
      renderCalendar();
      summaryDateEl.textContent = "Chọn một ngày để xem chi tiết";
      summaryContentEl.innerHTML = "";
      statisticsModal.classList.remove("hidden");
    });

    statisticsCloseBtn.addEventListener('click', () => {
      statisticsModal.classList.add("hidden");
    });

    btnTasks.addEventListener('click', () => {
      if (isRunning) return; // disable while running
      updateTaskProgress();
      tasksModal.classList.remove("hidden");
    });

    tasksCloseBtn.addEventListener('click', () => {
      tasksModal.classList.add("hidden");
    });

    // On load
    // Khởi tạo sessionHistory nếu chưa có
    if (!localStorage.getItem('sessionHistory')) {
      localStorage.setItem('sessionHistory', JSON.stringify([]));
    }

    // Khi load trang
    window.addEventListener("load", () => {
      updateCakeDisplay();
      updateStartButtonState();
      renderCakeMenu();

      if (user) {
        loginText.textContent = "Đăng xuất";
      }

      timeProgressBar.style.width = "100%";
    });
  </script>
</body>
</html>
