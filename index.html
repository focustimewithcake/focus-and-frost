<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Mind Map Generator - Mobile Optimized</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6b8cbc;
            --accent-color: #ff6b6b;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --success-color: #28a745;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--dark-color);
            line-height: 1.6;
            padding: 10px;
            overflow-x: hidden;
            touch-action: manipulation;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            text-align: center;
            padding: 20px 15px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }
        
        h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
        }
        
        .app-description {
            font-size: 0.9rem;
            opacity: 0.9;
            max-width: 100%;
            margin: 0 auto;
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
            padding: 15px;
        }
        
        .tab-container {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .tab {
            flex: 1;
            padding: 12px 5px;
            text-align: center;
            background: none;
            border: none;
            font-size: 0.9rem;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .section-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-title i {
            font-size: 1.5rem;
        }
        
        .upload-area {
            border: 2px dashed var(--secondary-color);
            border-radius: 8px;
            padding: 30px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background-color: rgba(107, 140, 188, 0.05);
            margin-bottom: 15px;
            position: relative;
        }
        
        .upload-area:hover {
            background-color: rgba(107, 140, 188, 0.1);
        }
        
        .upload-area i {
            font-size: 2.5rem;
            color: var(--secondary-color);
            margin-bottom: 10px;
        }
        
        .upload-text {
            margin-bottom: 15px;
            font-size: 0.9rem;
        }
        
        .btn {
            padding: 12px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            min-height: 44px; /* Đảm bảo kích thước chạm tốt trên mobile */
        }
        
        .btn:hover {
            background-color: var(--secondary-color);
        }
        
        .btn-block {
            width: 100%;
        }
        
        .btn-accent {
            background-color: var(--accent-color);
        }
        
        .btn-accent:hover {
            background-color: #ff5252;
        }
        
        .btn-success {
            background-color: var(--success-color);
        }
        
        .btn-success:hover {
            background-color: #218838;
        }
        
        .customization-options {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .option-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .option-group label {
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .option-group select, .option-group input {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            min-height: 44px; /* Đảm bảo kích thước chạm tốt */
        }
        
        .template-gallery {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .template-item {
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .template-item.active {
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(74, 111, 165, 0.3);
        }
        
        .template-item img {
            width: 100%;
            height: 70px;
            object-fit: cover;
        }
        
        .template-name {
            padding: 8px 3px;
            text-align: center;
            font-size: 0.75rem;
        }
        
        .mindmap-preview {
            min-height: 400px;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            background-color: #f9f9f9;
            position: relative;
            overflow: auto;
            -webkit-overflow-scrolling: touch; /* Cuộn mượt trên iOS */
        }
        
        .mindmap-container {
            width: 100%;
            height: 100%;
            position: relative;
            transform-origin: center center;
            transition: transform 0.3s;
            min-height: 350px;
        }
        
        .node {
            position: absolute;
            background: white;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            padding: 12px;
            min-width: 130px;
            max-width: 200px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s;
            z-index: 2;
            font-size: 0.85rem;
            touch-action: none; /* Cho phép kéo thả trên mobile */
        }
        
        .node:hover {
            transform: scale(1.02);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
            z-index: 3;
        }
        
        .node-title {
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--primary-color);
            border-bottom: 1px solid #eee;
            padding-bottom: 4px;
            font-size: 0.9rem;
        }
        
        .node-content {
            font-size: 0.8rem;
            min-height: 35px;
        }
        
        .node-image {
            margin-top: 8px;
            max-width: 100%;
            border-radius: 5px;
            max-height: 80px;
            object-fit: cover;
        }
        
        .central-node {
            background-color: var(--primary-color);
            color: white;
            z-index: 10;
        }
        
        .central-node .node-title {
            color: white;
            border-bottom-color: rgba(255, 255, 255, 0.3);
        }
        
        .connection {
            position: absolute;
            background: #999;
            z-index: 1;
            transform-origin: 0 0;
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .progress-bar {
            height: 4px;
            background-color: #eee;
            border-radius: 5px;
            margin-top: 12px;
            overflow: hidden;
            display: none;
        }
        
        .progress {
            height: 100%;
            background-color: var(--success-color);
            width: 0%;
            transition: width 0.3s;
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 150px;
            margin-top: 12px;
            border-radius: 8px;
            display: none;
        }
        
        .status-message {
            margin-top: 8px;
            padding: 8px;
            border-radius: 5px;
            display: none;
            font-size: 0.85rem;
        }
        
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-info {
            background-color: #cce5ff;
            color: #004085;
            border: 1px solid #b8daff;
        }
        
        .zoom-controls {
            position: absolute;
            bottom: 15px;
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 10;
        }
        
        .zoom-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            font-size: 1rem;
        }
        
        .node-controls {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 4px;
        }
        
        .node-btn {
            width: 22px;
            height: 22px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.9);
            color: var(--dark-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 10px;
            transition: all 0.2s;
        }
        
        .node-btn:hover {
            background: var(--primary-color);
            color: white;
        }
        
        footer {
            text-align: center;
            padding: 15px;
            color: #6c757d;
            background-color: #f8f9fa;
            border-top: 1px solid #eee;
            font-size: 0.8rem;
        }
        
        .mobile-notice {
            display: none;
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 0.85rem;
            border: 1px solid #ffeaa7;
        }
        
        /* Hiển thị thông báo trên mobile */
        @media (max-width: 768px) {
            .mobile-notice {
                display: block;
            }
            
            .action-buttons {
                grid-template-columns: 1fr;
            }
            
            .template-gallery {
                grid-template-columns: 1fr;
            }
        }
        
        /* Điều chỉnh cho màn hình rất nhỏ */
        @media (max-width: 480px) {
            h1 {
                font-size: 1.5rem;
            }
            
            .section-title {
                font-size: 1.1rem;
            }
            
            .node {
                min-width: 110px;
                padding: 8px;
            }
            
            .btn {
                padding: 10px 15px;
                font-size: 0.85rem;
            }
        }
        
        /* Tối ưu cho thiết bị di động */
        @media (hover: none) and (pointer: coarse) {
            .node:hover {
                transform: none;
            }
            
            .btn:hover {
                background-color: var(--primary-color);
            }
            
            .template-item:hover {
                transform: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>AI Mind Map Generator</h1>
            <p class="app-description">Tạo sơ đồ tư duy từ hình ảnh - Tối ưu cho điện thoại</p>
        </header>
        
        <div class="mobile-notice">
            <i class="fas fa-mobile-alt"></i> Ứng dụng đã được tối ưu cho điện thoại. Sử dụng hai ngón tay để phóng to/thu nhỏ sơ đồ.
        </div>
        
        <div class="main-content">
            <div class="tab-container">
                <button class="tab active" data-tab="upload">Tải ảnh</button>
                <button class="tab" data-tab="customize">Tùy chỉnh</button>
                <button class="tab" data-tab="preview">Sơ đồ</button>
            </div>
            
            <div class="tab-content active" id="upload-tab">
                <section class="upload-section">
                    <h2 class="section-title"><i class="fas fa-upload"></i> Tải ảnh lên</h2>
                    <div class="upload-area" id="uploadArea">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p class="upload-text">Chạm để chọn ảnh từ thiết bị của bạn</p>
                        <button class="btn btn-block" id="browseButton">
                            <i class="fas fa-folder-open"></i> Chọn ảnh
                        </button>
                        <input type="file" id="fileInput" accept="image/*" style="display: none;">
                    </div>
                    <img id="imagePreview" class="image-preview" alt="Xem trước ảnh">
                    <div class="progress-bar" id="progressBar">
                        <div class="progress" id="progress"></div>
                    </div>
                    <div id="statusMessage" class="status-message"></div>
                </section>
            </div>
            
            <div class="tab-content" id="customize-tab">
                <section class="customize-section">
                    <h2 class="section-title"><i class="fas fa-sliders-h"></i> Tuỳ chỉnh sơ đồ</h2>
                    <div class="customization-options">
                        <div class="option-group">
                            <label for="layoutStyle">Kiểu bố cục</label>
                            <select id="layoutStyle">
                                <option value="radial">Dạng tỏa tròn</option>
                                <option value="tree">Dạng cây</option>
                                <option value="organizational">Dạng tổ chức</option>
                                <option value="timeline">Dạng thời gian</option>
                            </select>
                        </div>
                        
                        <div class="option-group">
                            <label for="colorScheme">Màu sắc</label>
                            <select id="colorScheme">
                                <option value="blue">Xanh dương</option>
                                <option value="green">Xanh lá</option>
                                <option value="red">Đỏ</option>
                                <option value="purple">Tím</option>
                            </select>
                        </div>
                    </div>
                    
                    <h3 style="margin-top: 15px;">Mẫu sơ đồ</h3>
                    <div class="template-gallery">
                        <div class="template-item active" data-layout="radial">
                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='150' height='100' viewBox='0 0 150 100'%3E%3Ccircle cx='75' cy='50' r='30' fill='%234a6fa5'/%3E%3Ccircle cx='75' cy='50' r='40' fill='none' stroke='%234a6fa5' stroke-width='2'/%3E%3C/svg%3E" alt="Dạng tỏa tròn">
                            <div class="template-name">Tỏa tròn</div>
                        </div>
                        <div class="template-item" data-layout="tree">
                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='150' height='100' viewBox='0 0 150 100'%3E%3Cpath d='M75,20 V80 M75,30 H40 M75,30 H110 M75,50 H30 M75,50 H120' stroke='%2328a745' stroke-width='2' fill='none'/%3E%3Ccircle cx='75' cy='20' r='10' fill='%2328a745'/%3E%3Ccircle cx='40' cy='30' r='10' fill='%2328a745'/%3E%3Ccircle cx='110' cy='30' r='10' fill='%2328a745'/%3E%3Ccircle cx='30' cy='50' r='10' fill='%2328a745'/%3E%3Ccircle cx='120' cy='50' r='10' fill='%2328a745'/%3E%3C/svg%3E" alt="Dạng cây">
                            <div class="template-name">Dạng cây</div>
                        </div>
                    </div>
                </section>
            </div>
            
            <div class="tab-content" id="preview-tab">
                <section class="preview-section">
                    <h2 class="section-title"><i class="fas fa-eye"></i> Sơ đồ tư duy</h2>
                    <div class="mindmap-preview">
                        <div class="mindmap-container" id="mindmapContainer">
                            <!-- Sơ đồ tư duy sẽ được hiển thị ở đây -->
                            <div class="node central-node" style="top: 50%; left: 50%; transform: translate(-50%, -50%);">
                                <div class="node-title">Chủ đề chính</div>
                                <div class="node-content">Tải ảnh lên để bắt đầu</div>
                            </div>
                        </div>
                        <div class="zoom-controls">
                            <div class="zoom-btn" id="zoomIn"><i class="fas fa-plus"></i></div>
                            <div class="zoom-btn" id="zoomOut"><i class="fas fa-minus"></i></div>
                            <div class="zoom-btn" id="resetZoom"><i class="fas fa-sync-alt"></i></div>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn" id="addNodeBtn">
                            <i class="fas fa-plus-circle"></i> Thêm nhánh
                        </button>
                        <button class="btn" id="addImageBtn">
                            <i class="fas fa-image"></i> Thêm ảnh
                        </button>
                        <button class="btn btn-success" id="saveBtn">
                            <i class="fas fa-save"></i> Lưu
                        </button>
                        <button class="btn btn-accent" id="downloadBtn">
                            <i class="fas fa-download"></i> Tải xuống
                        </button>
                    </div>
                </section>
            </div>
        </div>
        
        <footer>
            <p>© 2023 AI Mind Map Generator | Tối ưu cho thiết bị di động</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.getElementById('uploadArea');
            const browseButton = document.getElementById('browseButton');
            const progressBar = document.getElementById('progressBar');
            const progress = document.getElementById('progress');
            const mindmapContainer = document.getElementById('mindmapContainer');
            const addImageBtn = document.getElementById('addImageBtn');
            const addNodeBtn = document.getElementById('addNodeBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const saveBtn = document.getElementById('saveBtn');
            const imagePreview = document.getElementById('imagePreview');
            const statusMessage = document.getElementById('statusMessage');
            const zoomIn = document.getElementById('zoomIn');
            const zoomOut = document.getElementById('zoomOut');
            const resetZoom = document.getElementById('resetZoom');
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            let currentZoom = 1;
            let selectedNode = null;
            let isDragging = false;
            let dragOffset = { x: 0, y: 0 };
            let touchStartX, touchStartY;
            
            // Xử lý chuyển tab
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    // Xóa active class từ tất cả tabs và contents
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    // Thêm active class cho tab và content được chọn
                    tab.classList.add('active');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
            
            // Xử lý sự kiện tải lên ảnh
            browseButton.addEventListener('click', function() {
                fileInput.click();
            });
            
            uploadArea.addEventListener('click', function() {
                fileInput.click();
            });
            
            // Hỗ trợ kéo thả trên mobile
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.style.borderColor = '#4a6fa5';
                uploadArea.style.backgroundColor = 'rgba(107, 140, 188, 0.2)';
            });
            
            uploadArea.addEventListener('dragleave', function() {
                uploadArea.style.borderColor = '#6b8cbc';
                uploadArea.style.backgroundColor = 'rgba(107, 140, 188, 0.05)';
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.style.borderColor = '#6b8cbc';
                uploadArea.style.backgroundColor = 'rgba(107, 140, 188, 0.05)';
                
                if (e.dataTransfer.files.length) {
                    fileInput.files = e.dataTransfer.files;
                    handleImageUpload();
                }
            });
            
            fileInput.addEventListener('change', handleImageUpload);
            
            // Xử lý tải lên ảnh và hiển thị xem trước
            function handleImageUpload() {
                if (!fileInput.files.length) return;
                
                const file = fileInput.files[0];
                
                // Kiểm tra xem có phải là file ảnh không
                if (!file.type.match('image.*')) {
                    showStatus('Vui lòng chọn file ảnh!', 'error');
                    return;
                }
                
                // Kiểm tra kích thước file (giới hạn 5MB cho mobile)
                if (file.size > 5 * 1024 * 1024) {
                    showStatus('Ảnh quá lớn. Vui lòng chọn ảnh nhỏ hơn 5MB.', 'error');
                    return;
                }
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    // Hiển thị ảnh xem trước
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                    
                    // Chuyển đến tab preview
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    document.querySelector('[data-tab="preview"]').classList.add('active');
                    document.getElementById('preview-tab').classList.add('active');
                    
                    // Xử lý ảnh và tạo sơ đồ tư duy
                    processImageWithOCR(file);
                };
                
                reader.readAsDataURL(file);
            }
            
            // Xử lý ảnh với OCR thực sự
            function processImageWithOCR(file) {
                progressBar.style.display = 'block';
                progress.style.width = '10%';
                
                showStatus('Đang xử lý ảnh...', 'info');
                
                // Sử dụng Tesseract.js để nhận dạng văn bản
                Tesseract.recognize(
                    file,
                    'vie+eng', // Ngôn ngữ: Tiếng Việt + Tiếng Anh
                    { 
                        logger: message => {
                            if (message.status === 'recognizing text') {
                                progress.style.width = `${message.progress * 100}%`;
                            }
                        }
                    }
                ).then(result => {
                    progress.style.width = '100%';
                    
                    // Hiển thị kết quả nhận dạng
                    const extractedText = result.data.text || "Không thể nhận dạng văn bản. Vui lòng thử với hình ảnh rõ nét hơn.";
                    
                    showStatus('Nhận dạng văn bản thành công!', 'success');
                    
                    // Tạo sơ đồ tư duy từ văn bản
                    createMindMap(extractedText);
                    
                    // Ẩn thanh tiến trình sau khi hoàn thành
                    setTimeout(function() {
                        progressBar.style.display = 'none';
                    }, 1000);
                }).catch(err => {
                    showStatus('Lỗi khi nhận dạng văn bản: ' + err.message, 'error');
                    progressBar.style.display = 'none';
                });
            }
            
            // Hiển thị thông báo trạng thái
            function showStatus(message, type) {
                statusMessage.textContent = message;
                statusMessage.className = 'status-message';
                statusMessage.classList.add(`status-${type}`);
                statusMessage.style.display = 'block';
                
                // Tự động ẩn thông báo sau 5 giây
                setTimeout(() => {
                    statusMessage.style.display = 'none';
                }, 5000);
            }
            
            // Tạo sơ đồ tư duy từ văn bản
            function createMindMap(text) {
                // Xóa nội dung cũ
                mindmapContainer.innerHTML = '';
                
                // Tách văn bản thành các dòng
                const lines = text.split('\n').filter(line => line.trim().length > 0);
                
                // Tạo nút trung tâm
                const centralNode = createNode('Chủ đề chính', lines.length > 0 ? lines[0] : 'Nội dung chính', true);
                centralNode.style.top = '50%';
                centralNode.style.left = '50%';
                centralNode.style.transform = 'translate(-50%, -50%)';
                
                mindmapContainer.appendChild(centralNode);
                
                // Tạo các nút con từ các dòng còn lại
                if (lines.length > 1) {
                    for (let i = 1; i < Math.min(lines.length, 5); i++) {
                        const angle = (i-1) * (2 * Math.PI / (lines.length - 1));
                        const radius = 120; // Giảm bán kính cho mobile
                        const top = 50 + Math.sin(angle) * radius / 2;
                        const left = 50 + Math.cos(angle) * radius;
                        
                        const node = createNode(`Ý tưởng ${i}`, lines[i]);
                        node.style.top = `${top}%`;
                        node.style.left = `${left}%`;
                        
                        mindmapContainer.appendChild(node);
                    }
                } else {
                    // Tạo các nút mẫu nếu không đủ nội dung
                    createSampleNodes(centralNode);
                }
                
                // Cho phép kéo thả các node
                enableDragging();
            }
            
            // Tạo node mẫu
            function createSampleNodes(centralNode) {
                const sampleContents = [
                    "Ý tưởng sáng tạo",
                    "Ghi chú quan trọng",
                    "Kế hoạch hành động",
                    "Mục tiêu phát triển"
                ];
                
                sampleContents.forEach((content, i) => {
                    const angle = i * (2 * Math.PI / sampleContents.length);
                    const radius = 120; // Giảm bán kính cho mobile
                    const top = 50 + Math.sin(angle) * radius / 2;
                    const left = 50 + Math.cos(angle) * radius;
                    
                    const node = createNode(`Nhánh ${i+1}`, content);
                    node.style.top = `${top}%`;
                    node.style.left = `${left}%`;
                    
                    mindmapContainer.appendChild(node);
                });
            }
            
            // Tạo một node mới
            function createNode(title, content, isCentral = false) {
                const node = document.createElement('div');
                node.className = isCentral ? 'node central-node' : 'node';
                
                const nodeControls = document.createElement('div');
                nodeControls.className = 'node-controls';
                
                const editBtn = document.createElement('div');
                editBtn.className = 'node-btn';
                editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                editBtn.title = 'Chỉnh sửa';
                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    editNode(node);
                });
                
                const deleteBtn = document.createElement('div');
                deleteBtn.className = 'node-btn';
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.title = 'Xóa';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteNode(node);
                });
                
                nodeControls.appendChild(editBtn);
                if (!isCentral) {
                    nodeControls.appendChild(deleteBtn);
                }
                
                node.innerHTML = `
                    <div class="node-title" contenteditable="true">${title}</div>
                    <div class="node-content" contenteditable="true">${content}</div>
                `;
                
                node.appendChild(nodeControls);
                
                // Chọn node khi chạm
                node.addEventListener('click', (e) => {
                    if (e.target.classList.contains('node-btn')) return;
                    
                    document.querySelectorAll('.node').forEach(n => {
                        n.style.zIndex = 2;
                        n.style.boxShadow = '0 2px 5px rgba(0, 0, 0, 0.1)';
                    });
                    
                    node.style.zIndex = 4;
                    node.style.boxShadow = '0 3px 10px rgba(0, 0, 0, 0.3)';
                    
                    selectedNode = node;
                });
                
                return node;
            }
            
            // Cho phép kéo thả các node (hỗ trợ cả touch)
            function enableDragging() {
                const nodes = document.querySelectorAll('.node');
                
                nodes.forEach(node => {
                    // Sự kiện cho desktop
                    node.addEventListener('mousedown', startDrag);
                    
                    // Sự kiện cho mobile
                    node.addEventListener('touchstart', handleTouchStart, { passive: false });
                    node.addEventListener('touchmove', handleTouchMove, { passive: false });
                    node.addEventListener('touchend', handleTouchEnd);
                });
                
                document.addEventListener('mousemove', drag);
                document.addEventListener('mouseup', stopDrag);
            }
            
            // Xử lý touch start
            function handleTouchStart(e) {
                if (e.target.classList.contains('node-btn')) return;
                
                const touch = e.touches[0];
                touchStartX = touch.clientX;
                touchStartY = touch.clientY;
                
                selectedNode = e.currentTarget;
                const rect = selectedNode.getBoundingClientRect();
                dragOffset.x = touch.clientX - rect.left;
                dragOffset.y = touch.clientY - rect.top;
                
                selectedNode.style.cursor = 'grabbing';
                e.preventDefault();
            }
            
            // Xử lý touch move
            function handleTouchMove(e) {
                if (!selectedNode) return;
                
                const touch = e.touches[0];
                const containerRect = mindmapContainer.getBoundingClientRect();
                
                let x = touch.clientX - containerRect.left - dragOffset.x;
                let y = touch.clientY - containerRect.top - dragOffset.y;
                
                // Giới hạn node trong container
                x = Math.max(0, Math.min(containerRect.width - selectedNode.offsetWidth, x));
                y = Math.max(0, Math.min(containerRect.height - selectedNode.offsetHeight, y));
                
                selectedNode.style.left = `${x}px`;
                selectedNode.style.top = `${y}px`;
                selectedNode.style.transform = 'none';
                
                e.preventDefault();
            }
            
            // Xử lý touch end
            function handleTouchEnd() {
                if (selectedNode) {
                    selectedNode.style.cursor = 'move';
                }
                selectedNode = null;
            }
            
            // Bắt đầu kéo (desktop)
            function startDrag(e) {
                if (e.button !== 0) return; // Chỉ xử lý click chuột trái
                if (e.target.classList.contains('node-btn')) return;
                
                isDragging = true;
                selectedNode = e.currentTarget;
                
                const rect = selectedNode.getBoundingClientRect();
                dragOffset.x = e.clientX - rect.left;
                dragOffset.y = e.clientY - rect.top;
                
                selectedNode.style.cursor = 'grabbing';
            }
            
            // Kéo node (desktop)
            function drag(e) {
                if (!isDragging || !selectedNode) return;
                
                const containerRect = mindmapContainer.getBoundingClientRect();
                
                let x = e.clientX - containerRect.left - dragOffset.x;
                let y = e.clientY - containerRect.top - dragOffset.y;
                
                // Giới hạn node trong container
                x = Math.max(0, Math.min(containerRect.width - selectedNode.offsetWidth, x));
                y = Math.max(0, Math.min(containerRect.height - selectedNode.offsetHeight, y));
                
                selectedNode.style.left = `${x}px`;
                selectedNode.style.top = `${y}px`;
                selectedNode.style.transform = 'none';
            }
            
            // Dừng kéo (desktop)
            function stopDrag() {
                if (!isDragging) return;
                
                isDragging = false;
                if (selectedNode) {
                    selectedNode.style.cursor = 'move';
                }
            }
            
            // Chỉnh sửa node
            function editNode(node) {
                const title = node.querySelector('.node-title');
                const content = node.querySelector('.node-content');
                
                title.focus();
                
                // Cho phép chỉnh sửa nội dung
                title.contentEditable = content.contentEditable = 'true';
                
                // Tự động lưu khi người dùng hoàn thành chỉnh sửa
                const saveEdit = () => {
                    title.contentEditable = content.contentEditable = 'false';
                    title.removeEventListener('blur', saveEdit);
                    content.removeEventListener('blur', saveEdit);
                };
                
                title.addEventListener('blur', saveEdit);
                content.addEventListener('blur', saveEdit);
            }
            
            // Xóa node
            function deleteNode(node) {
                if (node.classList.contains('central-node')) {
                    showStatus('Không thể xóa node trung tâm!', 'error');
                    return;
                }
                
                if (confirm('Bạn có chắc chắn muốn xóa nhánh này?')) {
                    node.remove();
                    showStatus('Đã xóa nhánh', 'info');
                }
            }
            
            // Xử lý sự kiện thêm ảnh vào ô
            addImageBtn.addEventListener('click', function() {
                if (!selectedNode) {
                    showStatus('Vui lòng chọn một nhánh để thêm ảnh', 'error');
                    return;
                }
                
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                
                input.onchange = function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    // Kiểm tra xem có phải là file ảnh không
                    if (!file.type.match('image.*')) {
                        showStatus('Vui lòng chọn file ảnh!', 'error');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        // Kiểm tra xem đã có ảnh trong node chưa
                        const existingImage = selectedNode.querySelector('.node-image');
                        if (existingImage) {
                            existingImage.src = event.target.result;
                        } else {
                            const img = document.createElement('img');
                            img.src = event.target.result;
                            img.className = 'node-image';
                            selectedNode.querySelector('.node-content').appendChild(img);
                        }
                        
                        showStatus('Đã thêm ảnh vào nhánh', 'success');
                    };
                    
                    reader.readAsDataURL(file);
                };
                
                input.click();
            });
            
            // Xử lý sự kiện thêm nhánh mới
            addNodeBtn.addEventListener('click', function() {
                if (!selectedNode) {
                    showStatus('Vui lòng chọn một nhánh để thêm nhánh con', 'error');
                    return;
                }
                
                const nodeCount = document.querySelectorAll('.node').length;
                const newNode = createNode(`Nhánh mới ${nodeCount}`, 'Nội dung nhánh mới');
                
                // Đặt vị trí ngẫu nhiên gần node cha
                const rect = selectedNode.getBoundingClientRect();
                const containerRect = mindmapContainer.getBoundingClientRect();
                
                const x = rect.left - containerRect.left + (Math.random() * 80 - 40);
                const y = rect.top - containerRect.top + (Math.random() * 80 - 40);
                
                newNode.style.left = `${x}px`;
                newNode.style.top = `${y}px`;
                newNode.style.transform = 'none';
                
                mindmapContainer.appendChild(newNode);
                
                showStatus('Đã thêm nhánh mới', 'success');
            });
            
            // Xử lý zoom
            zoomIn.addEventListener('click', function() {
                if (currentZoom < 2) {
                    currentZoom += 0.1;
                    updateZoom();
                }
            });
            
            zoomOut.addEventListener('click', function() {
                if (currentZoom > 0.5) {
                    currentZoom -= 0.1;
                    updateZoom();
                }
            });
            
            resetZoom.addEventListener('click', function() {
                currentZoom = 1;
                updateZoom();
            });
            
            function updateZoom() {
                mindmapContainer.style.transform = `scale(${currentZoom})`;
            }
            
            // Hỗ trợ pinch-to-zoom trên mobile
            let initialDistance = null;
            mindmapContainer.addEventListener('touchstart', function(e) {
                if (e.touches.length === 2) {
                    initialDistance = getDistance(e.touches[0], e.touches[1]);
                }
            });
            
            mindmapContainer.addEventListener('touchmove', function(e) {
                if (e.touches.length === 2 && initialDistance !== null) {
                    e.preventDefault();
                    const currentDistance = getDistance(e.touches[0], e.touches[1]);
                    const scale = currentDistance / initialDistance;
                    
                    if (scale > 1.1) {
                        // Zoom in
                        if (currentZoom < 2) {
                            currentZoom += 0.05;
                            updateZoom();
                        }
                        initialDistance = currentDistance;
                    } else if (scale < 0.9) {
                        // Zoom out
                        if (currentZoom > 0.5) {
                            currentZoom -= 0.05;
                            updateZoom();
                        }
                        initialDistance = currentDistance;
                    }
                }
            });
            
            mindmapContainer.addEventListener('touchend', function() {
                initialDistance = null;
            });
            
            function getDistance(touch1, touch2) {
                return Math.sqrt(
                    Math.pow(touch2.clientX - touch1.clientX, 2) +
                    Math.pow(touch2.clientY - touch1.clientY, 2)
                );
            }
            
            // Xử lý sự kiện tải xuống
            downloadBtn.addEventListener('click', function() {
                showStatus('Tính năng tải xuống đang được phát triển', 'info');
            });
            
            // Xử lý sự kiện lưu dự án
            saveBtn.addEventListener('click', function() {
                showStatus('Dự án đã được lưu tạm thời', 'success');
            });
            
            // Xử lý thay đổi tuỳ chọn
            document.getElementById('layoutStyle').addEventListener('change', function() {
                showStatus(`Đã chọn kiểu bố cục: ${this.options[this.selectedIndex].text}`, 'info');
            });
            
            document.getElementById('colorScheme').addEventListener('change', function() {
                showStatus(`Đã chọn màu sắc: ${this.options[this.selectedIndex].text}`, 'info');
                
                // Cập nhật màu sắc cho các node
                const color = this.value;
                let primaryColor = '#4a6fa5'; // Màu mặc định
                
                switch(color) {
                    case 'green': primaryColor = '#28a745'; break;
                    case 'red': primaryColor = '#dc3545'; break;
                    case 'purple': primaryColor = '#6f42c1'; break;
                }
                
                document.documentElement.style.setProperty('--primary-color', primaryColor);
            });
            
            // Xử lý chọn mẫu template
            document.querySelectorAll('.template-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.template-item').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    
                    const layout = this.getAttribute('data-layout');
                    document.getElementById('layoutStyle').value = layout;
                    showStatus(`Đã chọn mẫu: ${this.querySelector('.template-name').textContent}`, 'success');
                });
            });
        });
    </script>
</body>
</html>
